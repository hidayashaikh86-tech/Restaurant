<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Billing System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load PapaParse for CSV handling -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for print output (receipt) */
        @media print {
            body > * {
                visibility: hidden;
            }
            #receipt-print-area, #receipt-print-area * {
                visibility: visible;
            }
            #receipt-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 58mm; /* Standard thermal receipt width */
                margin: 0;
                padding: 10px;
                font-family: monospace;
                font-size: 10px;
            }
            .no-print {
                display: none !important;
            }
            @page {
                margin: 0.5cm; /* Minimal margin for clean thermal receipt printing */
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center transition-opacity duration-300">
        <svg class="animate-spin h-8 w-8 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-message" class="text-indigo-600 font-medium">Initializing application...</p>
        <p id="user-info" class="text-xs text-gray-500 mt-2"></p>
    </div>

    <header class="bg-indigo-600 shadow-lg text-white p-4">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-tight leading-tight">
                <span id="restaurant-name-display">QuickServe Restaurant</span>
                <span class="block text-xs sm:text-sm font-medium opacity-80">Billing System</span>
            </h1>
            <div class="flex items-center mt-2 sm:mt-0">
                <p id="user-id-display" class="text-sm font-light opacity-75 mr-4"></p>
                <button id="auth-button" onclick="signOutUser()" class="px-3 py-1 bg-red-500 hover:bg-red-600 rounded-lg text-sm font-semibold hidden">
                    <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i> Sign Out
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area - Initially Hidden -->
    <main id="app-main-content" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">

        <!-- Restaurant Menu Panel -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Restaurant Menu</h2>

            <!-- Control Bar -->
            <div class="flex flex-col sm:flex-row gap-2 mb-4">
                <input type="text" id="search-input" onkeyup="renderMenu()" placeholder="Search menu by name, category, or initials (e.g., 'cp' for 'Chhola Puri')..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                
                <button id="manage-menu-btn" onclick="showManageMenuModal()" disabled
                    class="px-4 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center">
                    <i data-lucide="utensils" class="w-5 h-5 mr-1"></i> Manage Menu
                </button>
                <button id="settings-btn" onclick="showSettingsModal()" disabled
                    class="px-4 py-3 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center">
                    <i data-lucide="settings" class="w-5 h-5 mr-1"></i> Settings
                </button>
                <button id="view-sales-btn" onclick="showOrderHistoryModal()" disabled
                    class="px-4 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 mr-1"></i> View Sales
                </button>
            </div>

            <!-- AI Special Section -->
            <div class="bg-yellow-100 p-4 rounded-lg shadow-inner mb-6 flex flex-col sm:flex-row items-center justify-between border-l-4 border-yellow-500">
                <p class="text-sm text-yellow-800 font-medium mb-2 sm:mb-0">
                    Use AI to generate a fresh special every day!
                </p>
                <button id="generate-special-btn" onclick="generateDailySpecial()" disabled
                    class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center">
                    <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i> Generate Daily Special
                </button>
            </div>


            <!-- Menu Items Container -->
            <div id="menu-items-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Menu items will be rendered here -->
            </div>
        </div>

        <!-- Current Order Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 sticky top-8 h-fit flex flex-col overflow-hidden lg:h-[calc(100vh-160px)]">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Current Order</h2>
            
            <div id="order-scroll-area" class="flex-1 min-h-0 overflow-y-auto pr-2">
                <div id="order-type-step" class="mb-4">
                    <div class="flex items-center justify-between">
                        <label for="order-type" class="block text-sm font-medium text-gray-700">Order For</label>
                        <button type="button" id="order-type-edit" onclick="expandStep('order-type')" class="text-xs text-indigo-600 font-semibold hidden">Edit</button>
                    </div>
                    <p id="order-type-summary" class="text-sm text-gray-600 mt-1 hidden"></p>
                    <div id="order-type-body" class="mt-2">
                        <select id="order-type" onchange="toggleTableSelection()" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="Table/Dine-In">Table/Dine-In</option>
                            <option value="Parcel/Takeaway">Parcel/Takeaway</option>
                        </select>
                    </div>
                </div>

                <div id="counter-step" class="mb-4">
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-700">Counter</label>
                        <button type="button" id="counter-edit" onclick="expandStep('counter')" class="text-xs text-indigo-600 font-semibold hidden">Edit</button>
                    </div>
                    <p id="counter-summary" class="text-sm text-gray-600 mt-1 hidden"></p>
                    <div id="counter-body" class="mt-2">
                        <div class="grid grid-cols-3 gap-2" id="counter-grid">
                            <button type="button" onclick="selectCounter('Counter 1')" data-counter="Counter 1"
                                class="counter-btn py-2 px-3 bg-indigo-600 text-white border-2 border-indigo-600 rounded-lg font-semibold text-sm transition duration-150">
                                Counter 1
                            </button>
                            <button type="button" onclick="selectCounter('Counter 2')" data-counter="Counter 2"
                                class="counter-btn py-2 px-3 bg-gray-100 text-gray-700 border-2 border-gray-300 rounded-lg font-semibold text-sm transition duration-150 hover:bg-indigo-100">
                                Counter 2
                            </button>
                            <button type="button" onclick="selectCounter('Counter 3')" data-counter="Counter 3"
                                class="counter-btn py-2 px-3 bg-gray-100 text-gray-700 border-2 border-gray-300 rounded-lg font-semibold text-sm transition duration-150 hover:bg-indigo-100">
                                Counter 3
                            </button>
                            <button type="button" onclick="selectCounter('Counter 4')" data-counter="Counter 4"
                                class="counter-btn py-2 px-3 bg-gray-100 text-gray-700 border-2 border-gray-300 rounded-lg font-semibold text-sm transition duration-150 hover:bg-indigo-100">
                                Counter 4
                            </button>
                            <button type="button" onclick="selectCounter('Counter 5')" data-counter="Counter 5"
                                class="counter-btn py-2 px-3 bg-gray-100 text-gray-700 border-2 border-gray-300 rounded-lg font-semibold text-sm transition duration-150 hover:bg-indigo-100">
                                Counter 5
                            </button>
                            <button type="button" onclick="selectCounter('Counter 6')" data-counter="Counter 6"
                                class="counter-btn py-2 px-3 bg-gray-100 text-gray-700 border-2 border-gray-300 rounded-lg font-semibold text-sm transition duration-150 hover:bg-indigo-100">
                                Counter 6
                            </button>
                        </div>
                        <div id="counter-compact" class="hidden">
                            <select id="counter-select" onchange="handleCompactCounterChange()" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                <option value="" disabled selected>Select counter</option>
                                <option value="Counter 1">Counter 1</option>
                                <option value="Counter 2">Counter 2</option>
                                <option value="Counter 3">Counter 3</option>
                                <option value="Counter 4">Counter 4</option>
                                <option value="Counter 5">Counter 5</option>
                                <option value="Counter 6">Counter 6</option>
                            </select>
                        </div>
                        <div id="counter-custom-row" class="mt-2 flex items-center gap-2">
                            <input type="text" id="counter-custom-input"
                                class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                                placeholder="Custom counter (optional)">
                            <button type="button" onclick="applyCustomCounter()"
                                class="px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white text-sm font-semibold rounded-lg">
                                Use
                            </button>
                        </div>
                        <input type="hidden" id="counter-selected" value="Counter 1">
                    </div>
                </div>

                <!-- Table Number Selection (shown only for Dine-In) -->
                <div id="table-step" class="mb-4">
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-700">Select Table Number</label>
                        <button type="button" id="table-edit" onclick="expandStep('table')" class="text-xs text-indigo-600 font-semibold hidden">Edit</button>
                    </div>
                    <p id="table-summary" class="text-sm text-gray-600 mt-1 hidden"></p>
                    <div id="table-body" class="mt-2">
                        <div id="table-selection-container">
                            <div id="table-grid" class="grid grid-cols-3 gap-2">
                                <button type="button" onclick="selectTable(1)" data-table="1" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 1
                                </button>
                                <button type="button" onclick="selectTable(2)" data-table="2" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 2
                                </button>
                                <button type="button" onclick="selectTable(3)" data-table="3" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 3
                                </button>
                                <button type="button" onclick="selectTable(4)" data-table="4" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 4
                                </button>
                                <button type="button" onclick="selectTable(5)" data-table="5" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 5
                                </button>
                                <button type="button" onclick="selectTable(6)" data-table="6" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 6
                                </button>
                                <button type="button" onclick="selectTable(7)" data-table="7" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 7
                                </button>
                                <button type="button" onclick="selectTable(8)" data-table="8" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 8
                                </button>
                                <button type="button" onclick="selectTable(9)" data-table="9" class="table-btn py-3 px-4 bg-gray-100 hover:bg-indigo-100 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition duration-150">
                                    Table 9
                                </button>
                            </div>
                            <div id="table-compact" class="hidden mt-2">
                                <select id="table-select" onchange="handleCompactTableChange()" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="" disabled selected>Select table</option>
                                    <option value="1">Table 1</option>
                                    <option value="2">Table 2</option>
                                    <option value="3">Table 3</option>
                                    <option value="4">Table 4</option>
                                    <option value="5">Table 5</option>
                                    <option value="6">Table 6</option>
                                    <option value="7">Table 7</option>
                                    <option value="8">Table 8</option>
                                    <option value="9">Table 9</option>
                                </select>
                            </div>
                        </div>
                        <input type="hidden" id="selected-table" value="">
                    </div>
                </div>

                <!-- Order List -->
                <div id="current-order-list" class="space-y-3 min-h-[100px]">
                    <!-- Order items will be rendered here -->
                    <p id="empty-order-message" class="text-gray-400 text-center italic mt-4">No items added yet.</p>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200 space-y-2 flex-shrink-0 bg-white">
                <div class="flex justify-between text-sm font-medium text-gray-600">
                    <span>Subtotal:</span>
                    <span id="subtotal">0.00</span>
                </div>
                <div class="flex justify-between text-sm font-medium text-gray-600">
                    <span id="tax-label">GST (5.00%):</span>
                    <span id="tax-amount">0.00</span>
                </div>
                <div class="flex justify-between text-lg font-bold text-indigo-600 border-t pt-2 mt-2">
                    <span>Total Payable:</span>
                    <span id="total-payable">0.00</span>
                </div>
                <button id="print-bill-btn" onclick="printBill()"
                    class="w-full mt-4 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg transition duration-150">
                    <i data-lucide="printer" class="w-5 h-5 inline mr-2"></i> Print Bill
                </button>
                <button onclick="clearOrder()"
                    class="w-full mt-2 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl shadow-md transition duration-150">
                    Clear Order
                </button>
            </div>
        </div>
    </main>
    
    <!-- AUTHENTICATION MODAL (STRICTLY SIGN IN ONLY) -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 transform transition-all">
            <h3 class="text-3xl font-bold text-indigo-600 mb-4 text-center">QuickServe Sign In (Subscription Required)</h3>
            <p id="auth-error-message" class="text-red-500 text-sm mb-4 text-center hidden"></p>
            
            <form id="auth-form" onsubmit="event.preventDefault(); handleAuth()">
                <div class="space-y-4">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="auth-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="staff@restaurant.com">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="auth-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="********">
                    </div>
                    
                    <button type="submit" id="auth-submit-btn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-md transition duration-150">
                        Sign In
                    </button>
                </div>
            </form>

            <div class="mt-6 text-center">
                <p class="text-sm text-gray-500">This service requires an active restaurant subscription. New users must be manually registered by the service administrator.</p>
            </div>
        </div>
    </div>


    <!-- Modal for Menu Management (Add, Import, Edit, Delete) -->
    <div id="manage-menu-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 transform transition-all">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex justify-between items-center">
                Menu Management
                <button onclick="hideManageMenuModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </h3>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Column 1: Add/Edit and Bulk Import Forms -->
                <div>
                    <h4 class="text-xl font-semibold mb-4 text-indigo-600">1. Add or Edit Item</h4>
                    
                    <form id="add-edit-item-form" onsubmit="event.preventDefault(); saveMenuItem()">
                        <input type="hidden" id="item-id-to-edit">
                        <div class="space-y-4">
                            <div>
                                <label for="item-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="item-name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="item-price" class="block text-sm font-medium text-gray-700">Price (â‚¹)</label>
                                    <input type="number" id="item-price" step="0.01" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="item-category" class="block text-sm font-medium text-gray-700">Category</label>
                                    <input type="text" id="item-category" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <button type="submit" id="add-save-btn"
                                class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Add Item
                            </button>
                        </div>
                    </form>

                    <h4 class="text-xl font-semibold my-4 pt-4 border-t text-indigo-600">2. Bulk Import (CSV)</h4>
                    <p class="text-xs text-gray-500 mb-2">Upload a CSV file with columns: **Name**, **Price**, **Category**</p>
                    <form id="bulk-import-form" onsubmit="event.preventDefault(); handleCSVUpload()">
                        <input type="file" id="csv-file-input" accept=".csv" required 
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <button type="submit" class="w-full mt-3 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                            <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i> Import CSV
                        </button>
                    </form>
                </div>
                
                <!-- Column 2: Current Menu List for Editing/Deleting -->
                <div>
                    <h4 class="text-xl font-semibold mb-4 text-indigo-600">3. Current Menu (Edit/Delete)</h4>
                    <div id="menu-management-list" class="max-h-[60vh] overflow-y-auto p-2 border border-gray-200 rounded-lg space-y-2">
                        <!-- Items list for edit/delete will render here -->
                        <p class="text-gray-400 text-center italic mt-4">Loading menu...</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t flex justify-end">
                <button onclick="hideManageMenuModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition duration-150">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Restaurant Settings -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all max-h-[85vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-2 border-b pb-3 flex justify-between items-center">
                Restaurant Settings
                <button onclick="hideSettingsModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </h3>
            <p class="text-sm text-gray-500 mb-4">Update your restaurant details and tax rate. Changes apply immediately across devices.</p>

            <form id="settings-form" onsubmit="event.preventDefault(); saveSettings()">
                <div class="space-y-4">
                    <div>
                        <label for="settings-restaurant-name" class="block text-sm font-medium text-gray-700">Restaurant Name</label>
                        <input type="text" id="settings-restaurant-name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="settings-gst-percent" class="block text-sm font-medium text-gray-700">GST % (0 - 100)</label>
                        <input type="number" id="settings-gst-percent" min="0" max="100" step="0.01" inputmode="decimal" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="settings-gstin" class="block text-sm font-medium text-gray-700">GSTIN (Optional)</label>
                        <input type="text" id="settings-gstin" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="22AAAAA0000A1Z5">
                    </div>
                    <div>
                        <label for="settings-phone" class="block text-sm font-medium text-gray-700">Phone (Optional)</label>
                        <input type="text" id="settings-phone" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="+91 98765 43210">
                    </div>
                    <div>
                        <label for="settings-address" class="block text-sm font-medium text-gray-700">Address (Optional)</label>
                        <textarea id="settings-address" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Street, City, State, PIN"></textarea>
                    </div>
                    <div>
                        <label for="settings-ui-mode" class="block text-sm font-medium text-gray-700">UI Mode</label>
                        <select id="settings-ui-mode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="default">Default (Buttons/Grid)</option>
                            <option value="compact">Compact (List + Step-by-Step)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Compact mode uses dropdowns and collapses steps after selection.</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-semibold text-gray-700">Cloud Sync</p>
                            <span class="text-xs text-gray-500">Local-first</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Data is stored on this device. Enable cloud sync to back up online.</p>
                        <label class="flex items-center gap-2 mt-2 text-sm text-gray-700">
                            <input type="checkbox" id="settings-auto-cloud-sync" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            Auto-sync changes to cloud
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Last cloud sync: <span id="cloud-sync-status">Never</span></p>
                        <div id="cloud-sync-indicator" class="hidden mt-2 text-xs text-indigo-600 font-semibold flex items-center gap-2">
                            <svg class="animate-spin h-4 w-4 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Syncing...
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mt-3">
                            <button type="button" id="cloud-sync-push-btn" onclick="syncToCloud(true)"
                                class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-lg">
                                Manual Save
                            </button>
                            <button type="button" id="cloud-sync-pull-btn" onclick="syncFromCloud(true)"
                                class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-sm font-semibold rounded-lg">
                                Manual Load
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Sync includes menu, settings, and sales history.</p>
                    </div>
                    <button type="submit" id="save-settings-btn"
                        class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                        <i data-lucide="save" class="w-4 h-4 inline mr-1"></i> Save Settings
                    </button>
                </div>
            </form>

            <div class="mt-6 pt-4 border-t flex justify-end">
                <button onclick="hideSettingsModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition duration-150">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Sales History -->
    <div id="order-history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 transform transition-all">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex justify-between items-center">
                Daily Sales History
                <div class="flex items-center space-x-2">
                    <button id="export-sales-btn" onclick="exportSalesHistoryCSV()" disabled
                        class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-lg shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="download" class="w-4 h-4 inline mr-1"></i> Export CSV
                    </button>
                    <button onclick="hideOrderHistoryModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </h3>

            <div class="flex flex-col sm:flex-row sm:items-end gap-3 mb-4">
                <div class="flex flex-col">
                    <label for="history-from-date" class="text-xs font-semibold text-gray-600 mb-1">From</label>
                    <input type="date" id="history-from-date" class="p-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <div class="flex flex-col">
                    <label for="history-to-date" class="text-xs font-semibold text-gray-600 mb-1">To</label>
                    <input type="date" id="history-to-date" class="p-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <button id="apply-history-filter-btn" onclick="applySalesHistoryFilter()"
                    class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-lg">
                    Apply
                </button>
                <button id="clear-history-filter-btn" onclick="clearSalesHistoryFilter()"
                    class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-sm font-semibold rounded-lg">
                    Clear
                </button>
            </div>

            <div id="order-history-content" class="max-h-[70vh] overflow-y-auto space-y-4">
                <!-- Sales data will be rendered here -->
                <p class="text-gray-400 text-center italic mt-4">Fetching sales data...</p>
            </div>

            <div class="mt-6 pt-4 border-t flex justify-end">
                <button onclick="hideOrderHistoryModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition duration-150">
                    Close
                </button>
            </div>
        </div>
    </div>


    <!-- Modal for Custom Alert/Confirm (Replaces alert() and confirm()) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <h4 id="modal-title" class="text-lg font-bold text-red-600 mb-3">Attention</h4>
            <p id="modal-message" class="text-gray-700 mb-6">Message content.</p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <!-- Action buttons will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Receipt Print Area (Hidden by default, used only for printing) -->
    <div id="receipt-print-area" class="no-print"></div>


    <script type="module">
        // Import necessary Firebase modules, including auth
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc, serverTimestamp, getDocs, orderBy, limit, getDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let restaurantId = null; // New variable to store the authorized restaurant ID
        let menuCollectionRef = null;
        let ordersCollectionRef = null;
        let settingsDocRef = null;
        
        // App State
        let menuItems = [];
        let currentOrder = [];
        let isMenuReady = false;
        let isSettingsReady = false;
        let salesHistoryCache = [];
        let salesHistoryFiltered = [];
        let bestMatchId = null;
        let cloudSyncActive = false;
        let menuUnsub = null;
        let settingsUnsub = null;
        
        // Constants
        const DEFAULT_SETTINGS = {
            restaurantName: 'QuickServe Restaurant',
            gstPercent: 5,
            gstNumber: '',
            phone: '',
            address: '',
            uiMode: 'default'
        };
        const UI_MODE_DEFAULT = 'default';
        const UI_MODE_COMPACT = 'compact';
        let restaurantSettings = { ...DEFAULT_SETTINGS };
        let taxRate = DEFAULT_SETTINGS.gstPercent / 100;
        let uiMode = DEFAULT_SETTINGS.uiMode;
        const PROXY_API_URL = 'http://localhost:3000/api/generate-special'; 
        // Define a global, publicly accessible path for the whitelist/tenant management
        const TENANT_WHITELIST_PATH = 'artifacts/global/public/data/restaurant_tenants'; 
        
        // UI Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const appMainContent = document.getElementById('app-main-content');
        const authModal = document.getElementById('auth-modal');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authErrorMsg = document.getElementById('auth-error-message');
        const authButton = document.getElementById('auth-button');
        const menuContainer = document.getElementById('menu-items-container');
        const orderList = document.getElementById('current-order-list');
        const manageMenuBtn = document.getElementById('manage-menu-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const viewSalesBtn = document.getElementById('view-sales-btn');
        const generateSpecialBtn = document.getElementById('generate-special-btn');
        const addSaveBtn = document.getElementById('add-save-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const exportSalesBtn = document.getElementById('export-sales-btn');
        const autoCloudSyncToggle = document.getElementById('settings-auto-cloud-sync');
        const cloudSyncPushBtn = document.getElementById('cloud-sync-push-btn');
        const cloudSyncPullBtn = document.getElementById('cloud-sync-pull-btn');
        const cloudSyncStatus = document.getElementById('cloud-sync-status');
        const cloudSyncIndicator = document.getElementById('cloud-sync-indicator');


        // --- UTILITY FUNCTIONS (Replaces alert/confirm) ---

        /**
         * Replaces window.alert() with a custom modal.
         * @param {string} message The message to display.
         * @param {string} title The title of the alert.
         * @param {string} type 'alert' or 'error'
         */
        function customAlert(message, title = 'Attention', type = 'alert') {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-title').classList.toggle('text-red-600', type === 'error');
            document.getElementById('modal-title').classList.toggle('text-indigo-600', type === 'alert');

            const actions = document.getElementById('modal-actions');
            actions.innerHTML = `
                <button id="modal-ok-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg">OK</button>
            `;
            modal.style.display = 'flex';

            document.getElementById('modal-ok-btn').onclick = () => {
                modal.style.display = 'none';
            };
        }

        /**
         * Replaces window.confirm() with a custom modal.
         * @param {string} message The confirmation message.
         * @param {string} title The title of the confirmation box.
         * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise.
         */
        function customConfirm(message, title = 'Confirm Action') {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                document.getElementById('modal-title').classList.remove('text-red-600');
                document.getElementById('modal-title').classList.add('text-indigo-600');

                const actions = document.getElementById('modal-actions');
                actions.innerHTML = `
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg">Confirm</button>
                `;
                modal.style.display = 'flex';

                document.getElementById('modal-cancel-btn').onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
                document.getElementById('modal-confirm-btn').onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };
            });
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function clampNumber(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        function formatPercent(value) {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) return '0.00';
            return numeric.toFixed(2);
        }

        function formatTaxLabel(percentValue) {
            return `GST (${formatPercent(percentValue)}%):`;
        }

        function formatTimestamp(value) {
            if (!value) return { date: '', time: '' };
            const date = value.toDate ? value.toDate() : new Date(value);
            if (Number.isNaN(date.getTime())) return { date: '', time: '' };
            return {
                date: date.toLocaleDateString(),
                time: date.toLocaleTimeString()
            };
        }

        function csvEscape(value) {
            const text = value === null || value === undefined ? '' : String(value);
            if (text.includes('"') || text.includes(',') || text.includes('\n')) {
                return `"${text.replace(/"/g, '""')}"`;
            }
            return text;
        }

        function slugifyFilename(value) {
            const base = value ? value.toString().toLowerCase() : '';
            const cleaned = base.replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            return cleaned || 'restaurant';
        }

        function highlightText(value, term) {
            if (!term) return escapeHtml(value);
            const lowerValue = value.toLowerCase();
            const lowerTerm = term.toLowerCase();
            const index = lowerValue.indexOf(lowerTerm);
            if (index === -1) return escapeHtml(value);

            const before = escapeHtml(value.slice(0, index));
            const match = escapeHtml(value.slice(index, index + lowerTerm.length));
            const after = escapeHtml(value.slice(index + lowerTerm.length));
            return `${before}<mark class="bg-yellow-200 text-gray-900 px-0.5 rounded">${match}</mark>${after}`;
        }

        function getSearchScore(item, searchTerm) {
            if (!searchTerm) return 0;
            const term = searchTerm.toLowerCase().trim();
            if (!term) return 0;
            const name = item.name.toLowerCase();
            const category = item.category.toLowerCase();

            if (name === term) return 100;
            if (name.startsWith(term)) return 90;
            if (name.includes(term)) return 70;
            if (category.startsWith(term)) return 60;
            if (category.includes(term)) return 50;
            if (matchesInitialism(item.name, term)) return 40;
            return 10;
        }

        function normalizeSettings(data = {}) {
            const restaurantName = (data.restaurantName || DEFAULT_SETTINGS.restaurantName).toString().trim() || DEFAULT_SETTINGS.restaurantName;
            const gstRaw = Number(data.gstPercent);
            const gstPercent = Number.isFinite(gstRaw) ? clampNumber(gstRaw, 0, 100) : DEFAULT_SETTINGS.gstPercent;
            const gstNumber = typeof data.gstNumber === 'string' ? data.gstNumber.trim() : '';
            const phone = typeof data.phone === 'string' ? data.phone.trim() : '';
            const address = typeof data.address === 'string' ? data.address.trim() : '';
            const uiModeValue = data.uiMode === UI_MODE_COMPACT ? UI_MODE_COMPACT : UI_MODE_DEFAULT;

            return { restaurantName, gstPercent, gstNumber, phone, address, uiMode: uiModeValue };
        }

        function applySettings(settings) {
            restaurantSettings = settings;
            taxRate = settings.gstPercent / 100;
            uiMode = settings.uiMode || UI_MODE_DEFAULT;

            const nameDisplay = document.getElementById('restaurant-name-display');
            if (nameDisplay) nameDisplay.textContent = settings.restaurantName;

            document.title = `${settings.restaurantName} Billing System`;

            const taxLabel = document.getElementById('tax-label');
            if (taxLabel) taxLabel.textContent = formatTaxLabel(settings.gstPercent);

            applyUiMode(uiMode);
            calculateTotals();

            maybeAutoSaveLocal();
        }

        function toggleSettingsReadyState(isReady) {
            isSettingsReady = isReady;
            if (settingsBtn) settingsBtn.disabled = !isReady;
        }

        function toggleExportReadyState(isReady) {
            if (exportSalesBtn) exportSalesBtn.disabled = !isReady;
        }

        function getLocalSnapshotKey() {
            if (!restaurantId) return null;
            return `quickserve_local_snapshot_${restaurantId}`;
        }

        function getCloudSyncPrefKey() {
            if (!restaurantId) return null;
            return `quickserve_cloud_autosync_${restaurantId}`;
        }

        function getCloudSyncStatusKey() {
            if (!restaurantId) return null;
            return `quickserve_cloud_last_sync_${restaurantId}`;
        }

        function isAutoCloudSyncEnabled() {
            const key = getCloudSyncPrefKey();
            if (!key) return false;
            return localStorage.getItem(key) === 'true';
        }

        function setAutoCloudSyncEnabled(value) {
            const key = getCloudSyncPrefKey();
            if (!key) return;
            localStorage.setItem(key, value ? 'true' : 'false');
        }

        function updateCloudSyncStatus(timestamp) {
            if (!cloudSyncStatus) return;
            if (!timestamp) {
                cloudSyncStatus.textContent = 'Never';
                return;
            }
            const date = new Date(timestamp);
            cloudSyncStatus.textContent = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        }

        function setCloudSyncIndicator(isSyncing) {
            if (!cloudSyncIndicator) return;
            cloudSyncIndicator.classList.toggle('hidden', !isSyncing);
        }

        let cloudSyncPending = 0;

        function beginCloudSync() {
            cloudSyncPending += 1;
            setCloudSyncIndicator(true);
        }

        function endCloudSync() {
            cloudSyncPending = Math.max(0, cloudSyncPending - 1);
            if (cloudSyncPending === 0) {
                setCloudSyncIndicator(false);
            }
        }

        async function runCloudSync(task) {
            beginCloudSync();
            try {
                return await task();
            } finally {
                endCloudSync();
            }
        }

        function storeCloudSyncTimestamp(timestamp) {
            const key = getCloudSyncStatusKey();
            if (!key) return;
            localStorage.setItem(key, String(timestamp));
            updateCloudSyncStatus(timestamp);
        }

        let historyDbPromise = null;

        function openHistoryDb() {
            if (typeof indexedDB === 'undefined') return Promise.resolve(null);
            if (!restaurantId) return Promise.resolve(null);
            if (historyDbPromise) return historyDbPromise;

            historyDbPromise = new Promise((resolve, reject) => {
                const request = indexedDB.open(`quickserve_history_${restaurantId}`, 1);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('history')) {
                        db.createObjectStore('history', { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });

            return historyDbPromise;
        }

        async function saveHistoryToIndexedDB(historyItems) {
            try {
                const db = await openHistoryDb();
                if (!db) return;
                await new Promise((resolve, reject) => {
                    const tx = db.transaction('history', 'readwrite');
                    const store = tx.objectStore('history');
                    store.clear();
                    historyItems.forEach(item => {
                        store.put({
                            ...item,
                            timestamp: item.timestamp?.toDate ? item.timestamp.toDate().toISOString() : item.timestamp
                        });
                    });
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                    tx.onabort = () => reject(tx.error);
                });
            } catch (error) {
                console.error("IndexedDB save error:", error);
            }
        }

        async function loadHistoryFromIndexedDB() {
            try {
                const db = await openHistoryDb();
                if (!db) return [];
                const tx = db.transaction('history', 'readonly');
                const store = tx.objectStore('history');
                const request = store.getAll();
                const data = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
                return normalizeHistory(data);
            } catch (error) {
                console.error("IndexedDB load error:", error);
                return [];
            }
        }

        function serializeHistory(historyItems) {
            if (!Array.isArray(historyItems)) return [];
            return historyItems.map(item => {
                const copy = { ...item };
                if (!copy.id) copy.id = crypto.randomUUID();
                if (copy.timestamp?.toDate) {
                    copy.timestamp = copy.timestamp.toDate().toISOString();
                } else if (copy.timestamp instanceof Date) {
                    copy.timestamp = copy.timestamp.toISOString();
                } else if (typeof copy.timestamp === 'number') {
                    copy.timestamp = new Date(copy.timestamp).toISOString();
                }
                return copy;
            });
        }

        function normalizeHistory(historyItems) {
            if (!Array.isArray(historyItems)) return [];
            return historyItems.map(item => {
                const copy = { ...item };
                if (!copy.id) copy.id = crypto.randomUUID();
                if (typeof copy.timestamp === 'string' || typeof copy.timestamp === 'number') {
                    const parsed = new Date(copy.timestamp);
                    if (!Number.isNaN(parsed.getTime())) {
                        copy.timestamp = parsed;
                    }
                }
                return copy;
            });
        }

        function saveLocalSnapshotInternal() {
            const key = getLocalSnapshotKey();
            if (!key) return;

            const payload = {
                version: 1,
                savedAt: Date.now(),
                restaurantId,
                settings: restaurantSettings,
                menu: menuItems,
                history: []
            };

            try {
                localStorage.setItem(key, JSON.stringify(payload));
            } catch (error) {
                console.error("Local save error:", error);
            }

            saveHistoryToIndexedDB(salesHistoryCache);
        }

        function applyLocalSnapshot(snapshot) {
            if (!snapshot) return;
            if (snapshot.settings) {
                applySettings(normalizeSettings(snapshot.settings));
                toggleSettingsReadyState(true);
            }
            if (Array.isArray(snapshot.menu)) {
                menuItems = snapshot.menu;
                renderMenu();
                renderManagementList();
                toggleReadyState(true);
            }
            if (Array.isArray(snapshot.history)) {
                salesHistoryCache = normalizeHistory(snapshot.history);
                renderSalesHistoryFromCache();
            }
        }

        async function loadLocalSnapshot(showAlert = false) {
            const key = getLocalSnapshotKey();
            if (!key) {
                if (showAlert) customAlert("Please sign in to load local data.", "Sign In Required");
                return;
            }

            const raw = localStorage.getItem(key);
            if (!raw) {
                if (showAlert) customAlert("No local data found on this device.", "Local Load");
                return;
            }

            try {
                const snapshot = JSON.parse(raw);
                applyLocalSnapshot(snapshot);
                const history = await loadHistoryFromIndexedDB();
                if (history.length > 0) {
                    salesHistoryCache = history;
                    renderSalesHistoryFromCache();
                }
                if (showAlert) customAlert("Loaded local data successfully.", "Local Load");
            } catch (error) {
                console.error("Local load error:", error);
                if (showAlert) customAlert("Failed to load local data.", "Local Load Error", 'error');
            }
        }

        function maybeAutoSaveLocal() {
            saveLocalSnapshotInternal();
        }

        function startCloudSync() {
            if (cloudSyncActive) return;
            if (!settingsDocRef || !menuCollectionRef) return;
            cloudSyncActive = true;
            settingsUnsub = subscribeToSettings();
            menuUnsub = subscribeToMenuChanges();
        }

        function stopCloudSync() {
            if (settingsUnsub) {
                settingsUnsub();
                settingsUnsub = null;
            }
            if (menuUnsub) {
                menuUnsub();
                menuUnsub = null;
            }
            cloudSyncActive = false;
        }

        async function syncToCloud(showAlert = false) {
            if (!settingsDocRef || !menuCollectionRef || !ordersCollectionRef) {
                if (showAlert) customAlert("Cloud sync is not available. Please sign in.", "Sync Error", 'error');
                return;
            }

            try {
                await runCloudSync(async () => {
                    await setDoc(settingsDocRef, { ...restaurantSettings, updatedAt: serverTimestamp() }, { merge: true });

                    const menuWrites = menuItems.map(item => {
                        const id = item.id || crypto.randomUUID();
                        const payload = { ...item };
                        delete payload.id;
                        return setDoc(doc(menuCollectionRef, id), payload, { merge: true });
                    });

                    const historyWrites = salesHistoryCache.map(order => {
                        const id = order.id || crypto.randomUUID();
                        const payload = { ...order };
                        delete payload.id;
                        return setDoc(doc(ordersCollectionRef, id), payload, { merge: true });
                    });

                    await Promise.all([...menuWrites, ...historyWrites]);
                });
                storeCloudSyncTimestamp(Date.now());

                if (showAlert) customAlert("Synced to cloud successfully.", "Cloud Sync");
            } catch (error) {
                console.error("Cloud sync error:", error);
                if (showAlert) customAlert("Failed to sync to cloud.", "Cloud Sync Error", 'error');
            }
        }

        async function syncFromCloud(showAlert = false) {
            if (!settingsDocRef || !menuCollectionRef || !ordersCollectionRef) {
                if (showAlert) customAlert("Cloud sync is not available. Please sign in.", "Sync Error", 'error');
                return;
            }

            try {
                const [settingsSnap, menuSnap, historySnap] = await runCloudSync(async () => {
                    return Promise.all([
                        getDoc(settingsDocRef),
                        getDocs(menuCollectionRef),
                        getDocs(ordersCollectionRef)
                    ]);
                });

                const settingsData = settingsSnap.exists() ? settingsSnap.data() : {};
                const menu = [];
                menuSnap.forEach(docSnap => {
                    menu.push({ id: docSnap.id, ...docSnap.data() });
                });

                const history = [];
                historySnap.forEach(docSnap => {
                    history.push({ id: docSnap.id, ...docSnap.data() });
                });

                applyLocalSnapshot({ settings: settingsData, menu, history });
                saveLocalSnapshotInternal();
                storeCloudSyncTimestamp(Date.now());

                if (showAlert) customAlert("Loaded data from cloud.", "Cloud Sync");
            } catch (error) {
                console.error("Cloud load error:", error);
                if (showAlert) customAlert("Failed to load from cloud.", "Cloud Sync Error", 'error');
            }
        }

        function setStepCollapsed(stepId, collapsed) {
            const body = document.getElementById(`${stepId}-body`);
            const summary = document.getElementById(`${stepId}-summary`);
            const editBtn = document.getElementById(`${stepId}-edit`);
            if (!body || !summary || !editBtn) return;

            body.classList.toggle('hidden', collapsed);
            summary.classList.toggle('hidden', !collapsed);
            editBtn.classList.toggle('hidden', !collapsed);
        }

        function expandStep(stepId) {
            setStepCollapsed(stepId, false);
            const body = document.getElementById(`${stepId}-body`);
            if (!body) return;
            const input = body.querySelector('select, input, button');
            if (input) input.focus();
        }

        function updateOrderSummary() {
            const orderType = document.getElementById('order-type').value;
            const summary = document.getElementById('order-type-summary');
            if (summary) summary.textContent = orderType || 'Not selected';
        }

        function updateCounterSummary() {
            const summary = document.getElementById('counter-summary');
            if (summary) summary.textContent = getCounterValue() || 'Not selected';
        }

        function updateTableSummary() {
            const value = document.getElementById('selected-table').value;
            const summary = document.getElementById('table-summary');
            if (summary) summary.textContent = value ? `Table ${value}` : 'Not selected';
        }

        function focusSearchInput() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.focus();
        }

        function focusOrderTypeSelect() {
            const select = document.getElementById('order-type');
            if (select) select.focus();
        }

        function focusCounterControl() {
            if (uiMode === UI_MODE_COMPACT) {
                const select = document.getElementById('counter-select');
                if (select) select.focus();
            } else {
                const btn = document.querySelector('.counter-btn');
                if (btn) btn.focus();
            }
        }

        function focusTableControl() {
            const tableStep = document.getElementById('table-step');
            if (tableStep && tableStep.classList.contains('hidden')) {
                focusPrintButton();
                return;
            }

            if (uiMode === UI_MODE_COMPACT) {
                const select = document.getElementById('table-select');
                if (select) select.focus();
            } else {
                const btn = document.querySelector('.table-btn');
                if (btn) btn.focus();
            }
        }

        function focusPrintButton() {
            const btn = document.getElementById('print-bill-btn');
            if (btn) btn.focus();
        }

        let enterTapCount = 0;
        let lastEnterTapAt = 0;

        function handleDoubleEnterFocus(now = Date.now()) {
            const delta = now - lastEnterTapAt;
            if (delta > 450) {
                enterTapCount = 1;
            } else {
                enterTapCount += 1;
            }
            lastEnterTapAt = now;

            if (enterTapCount >= 2) {
                enterTapCount = 0;
                focusOrderTypeSelect();
                return true;
            }
            return false;
        }

        function handleGridKeyNavigation(event, selector, columns, onSelect) {
            const keys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', ' '];
            if (!keys.includes(event.key)) return;

            const buttons = Array.from(document.querySelectorAll(selector));
            if (buttons.length === 0) return;
            const activeIndex = buttons.indexOf(document.activeElement);
            if (activeIndex === -1) return;

            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                onSelect(buttons[activeIndex]);
                return;
            }

            let nextIndex = activeIndex;
            if (event.key === 'ArrowLeft') nextIndex = Math.max(0, activeIndex - 1);
            if (event.key === 'ArrowRight') nextIndex = Math.min(buttons.length - 1, activeIndex + 1);
            if (event.key === 'ArrowUp') nextIndex = Math.max(0, activeIndex - columns);
            if (event.key === 'ArrowDown') nextIndex = Math.min(buttons.length - 1, activeIndex + columns);

            if (nextIndex !== activeIndex) {
                event.preventDefault();
                buttons[nextIndex].focus();
            }
        }

        function openSelectDropdown(selectEl) {
            if (!selectEl) return;
            selectEl.focus();
            if (typeof selectEl.showPicker === 'function') {
                selectEl.showPicker();
                return;
            }
            selectEl.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
            selectEl.dispatchEvent(new MouseEvent('mouseup', { bubbles: true }));
            selectEl.click();
        }

        function bindSelectFlow(selectId, nextFocusFn, onChange) {
            const selectEl = document.getElementById(selectId);
            if (!selectEl) return;

            selectEl.dataset.flowState = 'idle';
            selectEl.dataset.selectedAt = '0';

            selectEl.addEventListener('focus', () => {
                selectEl.dataset.flowState = 'idle';
            });

            selectEl.addEventListener('change', () => {
                selectEl.dataset.flowState = 'selected';
                selectEl.dataset.selectedAt = String(Date.now());
                if (onChange) onChange(selectEl.value);
            });

            selectEl.addEventListener('keydown', (event) => {
                if (event.key !== 'Enter') return;

                const state = selectEl.dataset.flowState || 'idle';
                const selectedAt = Number(selectEl.dataset.selectedAt || 0);

                if (state === 'idle') {
                    event.preventDefault();
                    openSelectDropdown(selectEl);
                    selectEl.dataset.flowState = 'opened';
                    return;
                }

                if (state === 'opened') {
                    // Allow native select to choose current option.
                    setTimeout(() => {
                        if (selectEl.dataset.flowState === 'opened') {
                            selectEl.dataset.flowState = 'selected';
                            selectEl.dataset.selectedAt = String(Date.now());
                        }
                    }, 0);
                    return;
                }

                if (state === 'selected') {
                    if (Date.now() - selectedAt < 300) {
                        event.preventDefault();
                        return;
                    }
                    event.preventDefault();
                    selectEl.dataset.flowState = 'idle';
                    if (nextFocusFn) nextFocusFn();
                }
            });
        }

        function applyUiMode(mode) {
            uiMode = mode === UI_MODE_COMPACT ? UI_MODE_COMPACT : UI_MODE_DEFAULT;
            const isCompact = uiMode === UI_MODE_COMPACT;

            const counterGrid = document.getElementById('counter-grid');
            const counterCompact = document.getElementById('counter-compact');
            const counterCustom = document.getElementById('counter-custom-row');
            const tableGrid = document.getElementById('table-grid');
            const tableCompact = document.getElementById('table-compact');
            const orderSummary = document.getElementById('order-type-summary');
            const counterSummary = document.getElementById('counter-summary');
            const tableSummary = document.getElementById('table-summary');
            const orderEdit = document.getElementById('order-type-edit');
            const counterEdit = document.getElementById('counter-edit');
            const tableEdit = document.getElementById('table-edit');

            if (counterGrid) counterGrid.classList.toggle('hidden', isCompact);
            if (counterCompact) counterCompact.classList.toggle('hidden', !isCompact);
            if (counterCustom) counterCustom.classList.toggle('hidden', isCompact);
            if (tableGrid) tableGrid.classList.toggle('hidden', isCompact);
            if (tableCompact) tableCompact.classList.toggle('hidden', !isCompact);

            const counterSelect = document.getElementById('counter-select');
            if (counterSelect) counterSelect.value = getCounterValue() || '';
            const tableSelect = document.getElementById('table-select');
            if (tableSelect) tableSelect.value = document.getElementById('selected-table').value || '';

            updateOrderSummary();
            updateCounterSummary();
            updateTableSummary();

            if (isCompact) {
                if (orderSummary) orderSummary.classList.add('hidden');
                if (counterSummary) counterSummary.classList.add('hidden');
                if (tableSummary) tableSummary.classList.add('hidden');
                if (orderEdit) orderEdit.classList.add('hidden');
                if (counterEdit) counterEdit.classList.add('hidden');
                if (tableEdit) tableEdit.classList.add('hidden');
                setStepCollapsed('order-type', false);
                setStepCollapsed('counter', false);
                setStepCollapsed('table', false);
            } else {
                setStepCollapsed('order-type', false);
                setStepCollapsed('counter', false);
                setStepCollapsed('table', false);
            }
        }

        function initializeCompactSteps() {
            const orderType = document.getElementById('order-type').value;
            const counterValue = getCounterValue();
            const tableValue = document.getElementById('selected-table').value;

            setStepCollapsed('order-type', !!orderType);
            setStepCollapsed('counter', !!counterValue);

            if (orderType === 'Table/Dine-In') {
                document.getElementById('table-step').classList.remove('hidden');
                setStepCollapsed('table', !!tableValue);
            } else {
                document.getElementById('table-step').classList.add('hidden');
            }
        }

        function selectCounter(counterValue, options = {}) {
            document.getElementById('counter-selected').value = counterValue;

            document.querySelectorAll('.counter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-300');
            });

            const selectedBtn = document.querySelector(`[data-counter="${counterValue}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-300');
                selectedBtn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
            }

            const counterSelect = document.getElementById('counter-select');
            if (counterSelect) {
                let option = Array.from(counterSelect.options).find(item => item.value === counterValue);
                if (!option) {
                    option = new Option(counterValue, counterValue);
                    counterSelect.add(option);
                }
                counterSelect.value = counterValue;
            }

            updateCounterSummary();

            const nextStep = options.nextStep || null;
            const shouldFocusSearch = options.focusSearch !== false;

            if (uiMode === UI_MODE_COMPACT && !options.silent) {
                if (nextStep === 'table') {
                    focusTableControl();
                } else if (nextStep === 'print') {
                    focusPrintButton();
                } else if (shouldFocusSearch) {
                    focusSearchInput();
                }
            } else if (!options.silent && nextStep === 'table') {
                focusTableControl();
            } else if (!options.silent && nextStep === 'print') {
                focusPrintButton();
            }
        }

        function handleCompactCounterChange() {
            const counterSelect = document.getElementById('counter-select');
            if (!counterSelect || !counterSelect.value) return;
            selectCounter(counterSelect.value, { silent: true, focusSearch: false });
        }

        function applyCustomCounter() {
            const customInput = document.getElementById('counter-custom-input');
            const value = customInput.value.trim();
            if (!value) {
                customAlert("Please enter a custom counter name/number.", "Counter Required");
                return;
            }
            selectCounter(value, { focusSearch: false });
            customInput.value = '';
        }

        function getCounterValue() {
            return document.getElementById('counter-selected').value.trim();
        }

        function selectTable(tableNumber, options = {}) {
            document.getElementById('selected-table').value = tableNumber;
            
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-300');
            });
            
            const selectedBtn = document.querySelector(`[data-table="${tableNumber}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-300');
                selectedBtn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
            }

            const tableSelect = document.getElementById('table-select');
            if (tableSelect) {
                tableSelect.value = String(tableNumber);
            }

            updateTableSummary();

            const nextStep = options.nextStep || null;
            const shouldFocusSearch = options.focusSearch !== false;

            if (uiMode === UI_MODE_COMPACT && !options.silent) {
                if (nextStep === 'print') {
                    focusPrintButton();
                } else if (shouldFocusSearch) {
                    focusSearchInput();
                }
            } else if (!options.silent && nextStep === 'print') {
                focusPrintButton();
            }
        }

        function handleCompactTableChange() {
            const tableSelect = document.getElementById('table-select');
            if (!tableSelect || !tableSelect.value) return;
            selectTable(tableSelect.value, { silent: true, focusSearch: false });
        }

        function resetTableSelection() {
            document.getElementById('selected-table').value = '';
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-300');
            });
            const tableSelect = document.getElementById('table-select');
            if (tableSelect) tableSelect.value = '';
            updateTableSummary();
        }


        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        
        /**
         * Converts Firebase error codes to user-friendly messages.
         * @param {string} code Firebase Auth error code
         * @returns {string} User-friendly message
         */
        function formatAuthError(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'Invalid email address format.';
                case 'auth/user-disabled':
                    return 'This account has been disabled.';
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                case 'auth/email-already-in-use':
                    return 'This email is already registered.';
                case 'auth/weak-password':
                    return 'Password must be at least 6 characters long.';
                case 'auth/operation-not-allowed':
                    return 'Email/Password sign-in is not enabled in Firebase settings.';
                default:
                    return `Authentication error: ${code.replace('auth/', '').replace(/-/g, ' ')}.`;
            }
        }

        // Handles the Sign In process
        async function handleAuth() {
            authErrorMsg.classList.add('hidden');
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            if (!email || !password) {
                authErrorMsg.textContent = "Please enter both email and password.";
                authErrorMsg.classList.remove('hidden');
                return;
            }

            authSubmitBtn.disabled = true;
            authSubmitBtn.textContent = 'Signing In...';

            try {
                // Sign in with Email and Password
                await signInWithEmailAndPassword(auth, email, password);
                
                // The onAuthStateChanged listener will now handle the next steps (Authorization Check)

            } catch (error) {
                console.error("Authentication Error:", error);
                authErrorMsg.textContent = formatAuthError(error.code);
                authErrorMsg.classList.remove('hidden');
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.textContent = 'Sign In';
            }
        }
        
        async function signOutUser() {
            const confirmed = await customConfirm("Are you sure you want to sign out?", "Confirm Sign Out");
            if (confirmed) {
                try {
                    // Clear local restaurant ID when signing out
                    restaurantId = null; 
                    await signOut(auth);
                    customAlert("Successfully signed out.", "Signed Out", 'alert');
                } catch (error) {
                    console.error("Sign Out Error:", error);
                    customAlert("Error signing out.", "Sign Out Failed", 'error');
                }
            }
        }
        
        /**
         * Checks if the user's UID is whitelisted as a tenant/subscriber.
         * On success, sets the global restaurantId to the tenant's ID.
         * @param {string} uid The Firebase User ID
         * @returns {Promise<string|null>} The restaurant ID if authorized, otherwise null.
         */
        async function checkSubscriptionAuthorization(uid) {
            if (!db) return null;

            try {
                // CRITICAL FIX: Use a document path directly instead of a query
                // This avoids the need for composite indexes
                const tenantDocRef = doc(db, TENANT_WHITELIST_PATH, uid);
                const tenantDocSnap = await getDoc(tenantDocRef);

                if (!tenantDocSnap.exists()) {
                    console.log(`Authorization failed for UID: ${uid}. Not found in tenant whitelist.`);
                    return null;
                }

                // Authorized! Extract the restaurantId field
                const rId = tenantDocSnap.data().restaurantId;
                
                if (!rId) {
                    console.error("Whitelist document found but 'restaurantId' field is missing or empty.");
                    return null;
                }
                
                console.log(`âœ… User ${uid} authorized for restaurant: ${rId}`);
                return rId;

            } catch (error) {
                console.error("Error during authorization check:", error);
                return null;
            }
        }


        async function initializeFirebase() {
            setLogLevel('debug');
            loadingMessage.textContent = "Initializing Firebase...";
            try {

                // ** --- START: Environment Variables for Firebase --- **
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyBTUoWpZHUq94JlGjhEjpQR6WbQjfTBY10",
                    authDomain: "restaurant-75c8e.firebaseapp.com",
                    projectId: "restaurant-75c8e",
                    storageBucket: "restaurant-75c8e.firebasestorage.app",
                    messagingSenderId: "86933612469",
                    appId: "1:86933612469:web:d3a0f03542a4e3830f1bfc",
                    measurementId: "G-8155CPE1WJ"
                };
                
                // CRITICAL FIX: Explicitly use the projectId as the appId for consistent path construction 
                // to match the security rules.
                const appId = firebaseConfig.projectId; 
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                // ** --- END: Environment Variables for Firebase --- **

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // Check if the user is anonymous (default state if no credentials are used)
                        if (user.isAnonymous) {
                             // Attempt to sign in with custom token if available, otherwise force login modal
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } 
                            // If still anonymous, we must force the user to sign in
                            if (auth.currentUser && auth.currentUser.isAnonymous) {
                                showAuthModal(appId, 'Please Sign In with your restaurant credentials.');
                            }
                            return; 
                        }

                        // --- STEP 1: Authorization Check for Non-Anonymous User ---
                        restaurantId = await checkSubscriptionAuthorization(userId);
                        
                        if (!restaurantId) {
                            // Authorization Failed: The user is logged in but not a whitelisted tenant
                            console.warn(`User ${user.email} is not an authorized tenant.`);
                            await signOut(auth); // Force sign out
                            showAuthModal(appId, 'Access Denied. Your restaurant email is not whitelisted for this service.');
                            return;
                        }


                        // --- STEP 2: Authorization SUCCESSFUL ---
                        document.getElementById('user-id-display').textContent = `Restaurant ID: ${restaurantId} | User: ${user.email}`;
                        authButton.classList.remove('hidden');
                        authModal.classList.add('hidden'); 
                        authModal.style.display = 'none'; // Explicitly hide the modal
                        appMainContent.classList.remove('hidden'); 

                        loadingMessage.textContent = "Authorized. Loading Menu Data...";

                        // Define collection references using the UNIQUE RESTAURANT ID, NOT the User ID
                        const menuPath = `artifacts/${appId}/users/${restaurantId}/restaurant_menu`;
                        const ordersPath = `artifacts/${appId}/users/${restaurantId}/completed_orders`;
                        const settingsPath = `artifacts/${appId}/users/${restaurantId}/restaurant_settings`;
                        menuCollectionRef = collection(db, menuPath);
                        ordersCollectionRef = collection(db, ordersPath);
                        settingsDocRef = doc(db, settingsPath, 'config');
                        
                        // Load local data first (offline-first)
                        loadLocalSnapshot(false);

                        if (isAutoCloudSyncEnabled()) {
                            startCloudSync();
                        } else {
                            toggleReadyState(true);
                            toggleSettingsReadyState(true);
                        }

                    } else {
                        // User is signed out
                        userId = null;
                        restaurantId = null;
                        settingsDocRef = null;
                        stopCloudSync();
                        salesHistoryCache = [];
                        toggleExportReadyState(false);
                        toggleSettingsReadyState(false);
                        applySettings({ ...DEFAULT_SETTINGS });
                        appMainContent.classList.add('hidden');
                        authButton.classList.add('hidden');
                        
                        // Fallback to anonymous sign-in (needed for platform environment), then force login
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        
                        // If we are still here and anonymous, show the login modal
                        if (auth.currentUser && auth.currentUser.isAnonymous) {
                            showAuthModal(appId, 'Please Sign In with your restaurant credentials.');
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingMessage.textContent = `Error: ${error.message}. Please check console and Firebase settings.`;
                loadingOverlay.classList.remove('opacity-90', 'flex');
                loadingOverlay.classList.add('bg-red-100', 'flex');
                document.getElementById('loading-message').classList.add('text-red-600');
            }
        }
        
        function showAuthModal(appId, message) {
            loadingOverlay.classList.add('hidden'); // Ensure loader is hidden
            authModal.classList.remove('hidden');
            authModal.style.display = 'flex';
            
            // Set initial message and context
            document.querySelector('#auth-modal h3').textContent = 'QuickServe Sign In (Subscription Required)';
            authErrorMsg.textContent = message;
            authErrorMsg.classList.remove('hidden');
            authErrorMsg.classList.add('text-indigo-600');
            
            // Reset state
            document.getElementById('auth-submit-btn').textContent = 'Sign In';
            document.getElementById('auth-form').reset();
            
            lucide.createIcons();
        }

        // Toggles interactive elements when the menu data is ready
        function toggleReadyState(isReady) {
            isMenuReady = isReady;
            // Only toggle these if main content is visible (i.e., user is authenticated)
            if (appMainContent.classList.contains('hidden') === false) {
                manageMenuBtn.disabled = !isReady;
                viewSalesBtn.disabled = !isReady;
                generateSpecialBtn.disabled = !isReady;
            }

            if (isReady) {
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                }, 300);
                // Ensure lucide icons are rendered after loading
                lucide.createIcons();
            }
        }

        function subscribeToSettings() {
            if (!settingsDocRef) return;

            const unsubscribe = onSnapshot(settingsDocRef, (docSnap) => {
                const settingsData = docSnap.exists() ? docSnap.data() : {};
                const normalized = normalizeSettings(settingsData);
                applySettings(normalized);
                toggleSettingsReadyState(true);
            }, (error) => {
                console.error("Error subscribing to settings:", error);
                toggleSettingsReadyState(false);
                customAlert("Failed to load restaurant settings. Check permissions in Firebase.", "Settings Error", 'error');
            });
            return unsubscribe;
        }

        function showSettingsModal() {
            if (!isSettingsReady) {
                customAlert("Please wait until the settings are fully loaded.", "Not Ready");
                return;
            }

            document.getElementById('settings-restaurant-name').value = restaurantSettings.restaurantName || DEFAULT_SETTINGS.restaurantName;
            document.getElementById('settings-gst-percent').value = formatPercent(restaurantSettings.gstPercent);
            document.getElementById('settings-gstin').value = restaurantSettings.gstNumber || '';
            document.getElementById('settings-phone').value = restaurantSettings.phone || '';
            document.getElementById('settings-address').value = restaurantSettings.address || '';
            document.getElementById('settings-ui-mode').value = restaurantSettings.uiMode || UI_MODE_DEFAULT;

            if (autoCloudSyncToggle) {
                autoCloudSyncToggle.checked = isAutoCloudSyncEnabled();
            }
            if (cloudSyncPushBtn) cloudSyncPushBtn.disabled = !restaurantId;
            if (cloudSyncPullBtn) cloudSyncPullBtn.disabled = !restaurantId;
            if (cloudSyncStatus) {
                const key = getCloudSyncStatusKey();
                const raw = key ? localStorage.getItem(key) : null;
                updateCloudSyncStatus(raw ? Number(raw) : null);
            }

            document.getElementById('settings-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function hideSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        async function saveSettings() {
            if (!settingsDocRef) return;

            const name = document.getElementById('settings-restaurant-name').value.trim();
            const gstPercentRaw = Number(document.getElementById('settings-gst-percent').value);
            const gstNumber = document.getElementById('settings-gstin').value.trim();
            const phone = document.getElementById('settings-phone').value.trim();
            const address = document.getElementById('settings-address').value.trim();
            const uiModeSelection = document.getElementById('settings-ui-mode').value;

            if (!name) {
                customAlert("Restaurant name is required.", "Input Error", 'error');
                return;
            }
            if (!Number.isFinite(gstPercentRaw) || gstPercentRaw < 0 || gstPercentRaw > 100) {
                customAlert("GST % must be a number between 0 and 100.", "Input Error", 'error');
                return;
            }

            const payload = {
                restaurantName: name,
                gstPercent: gstPercentRaw,
                gstNumber: gstNumber,
                phone: phone,
                address: address,
                uiMode: uiModeSelection === UI_MODE_COMPACT ? UI_MODE_COMPACT : UI_MODE_DEFAULT,
                updatedAt: serverTimestamp()
            };

            const originalLabel = saveSettingsBtn ? saveSettingsBtn.innerHTML : null;
            if (saveSettingsBtn) {
                saveSettingsBtn.disabled = true;
                saveSettingsBtn.textContent = 'Saving...';
            }

            try {
                applySettings(normalizeSettings(payload));
                maybeAutoSaveLocal();

                if (isAutoCloudSyncEnabled()) {
                    await runCloudSync(() => setDoc(settingsDocRef, payload, { merge: true }));
                }
                customAlert("Settings saved successfully!", "Success");
                hideSettingsModal();
            } catch (error) {
                console.error("Error saving settings:", error);
                customAlert("Failed to save settings. Check console.", "Settings Error", 'error');
            } finally {
                if (saveSettingsBtn) {
                    saveSettingsBtn.disabled = false;
                    if (originalLabel) saveSettingsBtn.innerHTML = originalLabel;
                }
            }
        }

        function subscribeToMenuChanges() {
            if (!menuCollectionRef) return;
            
            // Set up a real-time listener for the menu items
            const unsubscribe = onSnapshot(menuCollectionRef, (snapshot) => {
                const newMenuItems = [];
                snapshot.forEach(doc => {
                    // Store the Firestore document ID in the item object
                    newMenuItems.push({ id: doc.id, ...doc.data() });
                });
                menuItems = newMenuItems;
                
                // Rerender the menu and management list immediately
                renderMenu();
                renderManagementList();
                maybeAutoSaveLocal();

                // If this is the first successful load, set the ready state
                if (!isMenuReady) {
                    toggleReadyState(true);
                }
            }, (error) => {
                console.error("Error subscribing to menu changes:", error);
                customAlert("Failed to load menu data. Check permissions in Firebase.", "Database Error", 'error');
                toggleReadyState(false);
            });
            return unsubscribe;
        }


        // --- MENU LOGIC (RENDER & FILTER) ---

        /**
         * Checks if a search term matches the initials of the item name (e.g., 'cp' for 'Chhola Puri').
         * @param {string} itemName 
         * @param {string} searchTerm 
         * @returns {boolean}
         */
        function matchesInitialism(itemName, searchTerm) {
            const normalizedSearch = searchTerm.toLowerCase().replace(/\s/g, '');
            if (normalizedSearch.length === 0) return true;

            const words = itemName.toLowerCase().split(/\s+/).filter(word => word.length > 0);
            if (words.length === 0) return false;

            let initialism = '';
            for (const word of words) {
                initialism += word[0];
            }

            // Check if the search term is an initialism of the item name
            return initialism.startsWith(normalizedSearch);
        }

        function renderMenu() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filteredItems = menuItems.filter(item => {
                // Check for full text match in name or category
                const textMatch = item.name.toLowerCase().includes(searchTerm) || 
                                  item.category.toLowerCase().includes(searchTerm);
                
                // Check for initialism match in name
                const initialismMatch = matchesInitialism(item.name, searchTerm);

                return textMatch || initialismMatch;
            });

            menuContainer.innerHTML = '';

            if (filteredItems.length === 0) {
                menuContainer.innerHTML = `<p class="text-gray-400 text-center italic mt-4 col-span-2">No items found matching "${searchTerm}".</p>`;
                bestMatchId = null;
                return;
            }

            let bestMatch = null;
            let bestScore = -1;
            if (searchTerm.trim().length > 0) {
                filteredItems.forEach(item => {
                    const score = getSearchScore(item, searchTerm);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = item;
                    }
                });
            }
            bestMatchId = bestMatch ? bestMatch.id : null;

            filteredItems.forEach(item => {
                const isSpecial = item.isSpecial === true;
                const isBestMatch = bestMatchId && item.id === bestMatchId;
                const cardClass = isSpecial 
                    ? 'bg-yellow-50 border-yellow-300 hover:bg-yellow-100 shadow-md ring-2 ring-yellow-400' 
                    : 'bg-white border-gray-200 hover:bg-gray-50 shadow-sm';
                const highlightClass = isBestMatch ? 'ring-2 ring-indigo-400 bg-indigo-50' : '';
                const renderedName = highlightText(item.name, searchTerm);
                const renderedCategory = escapeHtml(item.category);
                const renderedDescription = item.description ? escapeHtml(item.description) : 'Daily AI Special';
                
                const html = `
                    <div onclick="addItemToOrderById('${item.id}')" 
                        class="p-4 rounded-xl border cursor-pointer transition duration-150 transform hover:scale-[1.01] ${cardClass} ${highlightClass}">
                        <div class="flex justify-between items-start">
                            <h4 class="text-lg font-semibold text-gray-800">${renderedName}</h4>
                            <span class="text-xl font-bold text-indigo-600">â‚¹${item.price.toFixed(2)}</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${renderedCategory}</p>
                        ${isSpecial ? `<p class="text-xs text-yellow-700 mt-2 font-medium italic">${renderedDescription}</p>` : ''}
                    </div>
                `;
                menuContainer.innerHTML += html;
            });
            // Re-render lucide icons after injecting new HTML
            lucide.createIcons(); 
        }


        // --- CURRENT ORDER LOGIC ---

        // New function to handle item selection using only the ID
        function addItemToOrderById(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) {
                console.error("Item not found in menuItems array:", itemId);
                return;
            }
            addItemToOrder(item.id, item.name, item.price);
        }

        function addBestMatchFromSearch() {
            if (!bestMatchId) return;
            addItemToOrderById(bestMatchId);
            const searchInput = document.getElementById('search-input');
            searchInput.value = '';
            renderMenu();
            searchInput.focus();
        }

        function addItemToOrder(itemId, itemName, itemPrice) {
            const existingItem = currentOrder.find(item => item.id === itemId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                currentOrder.push({
                    id: itemId,
                    name: itemName,
                    price: itemPrice,
                    quantity: 1
                });
            }
            renderOrder();
        }

        function updateQuantity(itemId, delta) {
            const itemIndex = currentOrder.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                currentOrder[itemIndex].quantity += delta;
                
                if (currentOrder[itemIndex].quantity <= 0) {
                    currentOrder.splice(itemIndex, 1); // Remove item if quantity is zero or less
                }
            }
            renderOrder();
        }

        function calculateTotals() {
            let subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let taxAmount = subtotal * taxRate;
            let totalPayable = subtotal + taxAmount;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
            document.getElementById('total-payable').textContent = totalPayable.toFixed(2);
            
            return { subtotal, taxAmount, totalPayable };
        }

        function renderOrder() {
            orderList.innerHTML = '';
            
            const emptyMessageElement = document.getElementById('empty-order-message');
            
            if (currentOrder.length === 0) {
                if (emptyMessageElement) emptyMessageElement.style.display = 'block';
            } else {
                if (emptyMessageElement) emptyMessageElement.style.display = 'none';
                
                currentOrder.forEach(item => {
                    const itemTotal = (item.price * item.quantity).toFixed(2);
                    orderList.innerHTML += `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg shadow-sm">
                            <div class="flex-grow">
                                <span class="font-medium text-gray-800">${item.name}</span>
                                <span class="text-xs text-gray-500 block">â‚¹${item.price.toFixed(2)} x ${item.quantity}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-semibold text-gray-700 mr-2">â‚¹${itemTotal}</span>
                                <button onclick="updateQuantity('${item.id}', -1)" class="text-white bg-red-400 hover:bg-red-500 w-6 h-6 rounded-full text-sm">-</button>
                                <button onclick="updateQuantity('${item.id}', 1)" class="text-white bg-green-400 hover:bg-green-500 w-6 h-6 rounded-full text-sm">+</button>
                            </div>
                        </div>
                    `;
                });
            }
            calculateTotals();
        }

        function clearOrder() {
            currentOrder = [];
            renderOrder();
            document.getElementById('order-type').value = 'Table/Dine-In';
            resetTableSelection();
            selectCounter('Counter 1', { silent: true });
            updateOrderSummary();
            updateCounterSummary();
            toggleTableSelection();
            customAlert("Current order cleared successfully.");
        }

        function toggleTableSelection() {
            const orderType = document.getElementById('order-type').value;
            const tableStep = document.getElementById('table-step');
            
            if (orderType === 'Table/Dine-In') {
                tableStep.classList.remove('hidden');
            } else {
                tableStep.classList.add('hidden');
                resetTableSelection();
            }

            updateOrderSummary();

            if (uiMode === UI_MODE_COMPACT) {
                const counterSelect = document.getElementById('counter-select');
                if (counterSelect) counterSelect.value = getCounterValue() || '';
                const tableSelect = document.getElementById('table-select');
                if (tableSelect) tableSelect.value = document.getElementById('selected-table').value || '';
            }
        }

        // --- ORDER SAVING & PRINTING ---

        /**
         * Saves the current order to the 'completed_orders' collection in Firestore.
         * @param {number} total The total payable amount.
         * @param {string} orderTypeDisplay The display string for order type (e.g., "Table 5")
         */
        async function saveCompletedOrder(total, orderTypeDisplay, counterDisplay) {
            if (currentOrder.length === 0) return;

            const localTimestamp = new Date();
            const localId = crypto.randomUUID();
            const orderData = {
                items: currentOrder.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    total: item.price * item.quantity
                })),
                totalPayable: total,
                subtotal: parseFloat(document.getElementById('subtotal').textContent),
                taxAmount: parseFloat(document.getElementById('tax-amount').textContent),
                taxPercent: restaurantSettings.gstPercent,
                restaurantName: restaurantSettings.restaurantName,
                orderType: orderTypeDisplay,
                counter: counterDisplay,
                timestamp: localTimestamp,
                restaurantId: restaurantId,
            };

            try {
                salesHistoryCache = [
                    {
                        id: localId,
                        ...orderData,
                    },
                    ...salesHistoryCache
                ];
                maybeAutoSaveLocal();

                if (isAutoCloudSyncEnabled() && ordersCollectionRef) {
                    await runCloudSync(() => setDoc(doc(ordersCollectionRef, localId), orderData, { merge: true }));
                    console.log("Order saved successfully to cloud history.");
                }
            } catch (error) {
                console.error("Error saving order to history:", error);
                customAlert("Failed to save order to sales history. Check console.", "Save Error", 'error');
            }
        }

        function printBill() {
            if (currentOrder.length === 0) {
                customAlert("Please add items to the order before printing the bill.", "Empty Order");
                return;
            }

            const orderType = document.getElementById('order-type').value;
            const selectedTable = document.getElementById('selected-table').value;
            const counterValue = getCounterValue();

            // Validate table selection for dine-in orders
            if (orderType === 'Table/Dine-In' && !selectedTable) {
                customAlert("Please select a table number for dine-in orders.", "Table Required");
                return;
            }
            if (!counterValue) {
                customAlert("Please enter the counter name/number.", "Counter Required");
                return;
            }

            const { subtotal, taxAmount, totalPayable } = calculateTotals();

            const safeRestaurantName = escapeHtml(restaurantSettings.restaurantName || DEFAULT_SETTINGS.restaurantName);
            const safeGstNumber = escapeHtml(restaurantSettings.gstNumber || '');
            const safePhone = escapeHtml(restaurantSettings.phone || '');
            const safeAddress = escapeHtml(restaurantSettings.address || '');
            const gstLabel = formatTaxLabel(restaurantSettings.gstPercent);

            const receiptMetaLines = [];
            if (restaurantId) {
                receiptMetaLines.push(`<p style="font-size: 10px; margin: 0 0 6px 0; text-align: center;">Restaurant ID: ${escapeHtml(restaurantId)}</p>`);
            }
            if (safeGstNumber) {
                receiptMetaLines.push(`<p style="font-size: 10px; margin: 0 0 4px 0; text-align: center;">GSTIN: ${safeGstNumber}</p>`);
            }
            if (safePhone) {
                receiptMetaLines.push(`<p style="font-size: 10px; margin: 0 0 4px 0; text-align: center;">Phone: ${safePhone}</p>`);
            }
            if (safeAddress) {
                receiptMetaLines.push(`<p style="font-size: 10px; margin: 0 0 6px 0; text-align: center;">${safeAddress}</p>`);
            }
            
            // Build order type string
            let orderTypeDisplay = orderType;
            if (orderType === 'Table/Dine-In' && selectedTable) {
                orderTypeDisplay = `Table ${selectedTable}`;
            }

            // 1. Save the order to history
            saveCompletedOrder(totalPayable, orderTypeDisplay, counterValue);

            // 2. Generate the receipt HTML
            let receiptItems = currentOrder.map(item => `
                <div style="display:flex; justify-content:space-between; font-size: 10px;">
                    <span>${item.name} (x${item.quantity})</span>
                    <span>â‚¹${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');

            const receiptHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QuickServe Receipt</title>
                    <style>
                        body { margin: 0; padding: 0; }
                        @page { margin: 0.5cm; }
                        .receipt {
                            width: 58mm;
                            margin: 0 auto;
                            padding: 10px;
                            font-family: monospace;
                            font-size: 10px;
                            line-height: 1.4;
                            color: #000;
                        }
                        hr { border-top: 1px dashed black; margin: 5px 0; border-bottom: none; }
                    </style>
                </head>
                <body>
                    <div class="receipt" id="receipt-content">
                        <h1 style="font-size: 14px; margin: 0 0 5px 0; font-weight: bold; text-align: center;">${safeRestaurantName}</h1>
                        ${receiptMetaLines.join('')}
                        <hr>
                        <div style="text-align: left; margin-bottom: 5px;">
                            <p style="font-size: 10px; margin: 2px 0; font-weight: bold;">Order: ${orderTypeDisplay}</p>
                            <p style="font-size: 10px; margin: 2px 0;">Counter: ${escapeHtml(counterValue)}</p>
                            <p style="font-size: 10px; margin: 2px 0;">Date: ${new Date().toLocaleDateString()}</p>
                            <p style="font-size: 10px; margin: 2px 0;">Time: ${new Date().toLocaleTimeString()}</p>
                        </div>
                        <hr>
                        
                        <div style="text-align: left; margin-top: 10px; margin-bottom: 10px; font-weight: bold;">
                            ${receiptItems}
                        </div>
                        
                        <hr>
                        <div style="text-align: right; margin-top: 5px;">
                            <div style="display:flex; justify-content:space-between; font-size: 10px;"><span>Subtotal:</span><span>â‚¹${subtotal.toFixed(2)}</span></div>
                            <div style="display:flex; justify-content:space-between; font-size: 10px;"><span>${gstLabel}</span><span>â‚¹${taxAmount.toFixed(2)}</span></div>
                            <div style="display:flex; justify-content:space-between; font-size: 12px; margin-top: 5px; font-weight: bold;"><span>TOTAL:</span><span>â‚¹${totalPayable.toFixed(2)}</span></div>
                        </div>
                        
                        <hr>
                        <p style="font-size: 10px; margin-top: 10px; text-align: center;">Thank You! Visit Again.</p>
                    </div>
                </body>
                </html>
            `;

            // 3. Open a new window, write HTML, and print
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(receiptHTML);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            } else {
                customAlert("Please allow pop-ups for the printing feature to work.", "Pop-up Blocked", 'error');
            }
            
            // 4. Clear the order after printing
            clearOrder();
        }


        // --- MENU MANAGEMENT (ADD/EDIT/DELETE/CSV) ---

        function showManageMenuModal() {
            if (!isMenuReady) {
                customAlert("Please wait until the app is fully initialized and menu data is loaded.", "Not Ready");
                return;
            }
            document.getElementById('manage-menu-modal').style.display = 'flex';
            // Render the list of current items for editing/deleting
            renderManagementList(); 
        }

        function hideManageMenuModal() {
            document.getElementById('manage-menu-modal').style.display = 'none';
            // Reset the form state
            document.getElementById('add-edit-item-form').reset();
            document.getElementById('item-id-to-edit').value = '';
            addSaveBtn.textContent = 'Add Item';
            lucide.createIcons();
        }

        // Renders the list of menu items inside the management modal for editing/deleting
        function renderManagementList() {
            const listContainer = document.getElementById('menu-management-list');
            listContainer.innerHTML = '';

            if (menuItems.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-400 text-center italic mt-4">No menu items added yet.</p>`;
                return;
            }

            // Sort items alphabetically by name for easy management
            const sortedItems = [...menuItems].sort((a, b) => a.name.localeCompare(b.name));

            sortedItems.forEach(item => {
                listContainer.innerHTML += `
                    <div class="flex items-center justify-between p-2 border border-gray-200 rounded-lg bg-white shadow-sm">
                        <div class="flex-grow">
                            <span class="font-semibold text-gray-800">${item.name}</span>
                            <span class="text-sm text-gray-500 block">â‚¹${item.price.toFixed(2)} (${item.category})</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editMenuItem('${item.id}')" class="text-indigo-600 hover:text-indigo-800 p-1 rounded hover:bg-indigo-50 transition duration-150">
                                <i data-lucide="square-pen" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteMenuItem('${item.id}')" class="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-50 transition duration-150">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // Populates the form to edit an existing item
        function editMenuItem(itemId) {
            const itemToEdit = menuItems.find(item => item.id === itemId);
            if (!itemToEdit) return;

            document.getElementById('item-id-to-edit').value = itemId;
            document.getElementById('item-name').value = itemToEdit.name;
            document.getElementById('item-price').value = itemToEdit.price;
            document.getElementById('item-category').value = itemToEdit.category;
            addSaveBtn.textContent = 'Save Changes';
            customAlert(`Editing: ${itemToEdit.name}. Scroll up to the form to modify details.`, 'Editing Item');
        }

        // Handles both adding a new item and saving changes to an existing one
        async function saveMenuItem() {
            const idToEdit = document.getElementById('item-id-to-edit').value;
            const name = document.getElementById('item-name').value.trim();
            const price = parseFloat(document.getElementById('item-price').value);
            const category = document.getElementById('item-category').value.trim();

            if (!name || isNaN(price) || price <= 0 || !category) {
                customAlert("Please enter valid name, price, and category.", "Input Error", 'error');
                return;
            }

            // Check for duplicates ONLY when adding a new item
            if (!idToEdit) {
                const isDuplicate = menuItems.some(item => item.name.toLowerCase() === name.toLowerCase());
                if (isDuplicate) {
                    customAlert(`An item named "${name}" already exists. Please edit the existing item or use a different name.`, "Duplicate Item", 'error');
                    return;
                }
            }

            const newItemData = {
                name: name,
                price: price,
                category: category,
            };

            try {
                if (idToEdit) {
                    // Update existing item (local-first)
                    const index = menuItems.findIndex(item => item.id === idToEdit);
                    if (index > -1) {
                        menuItems[index] = { ...menuItems[index], ...newItemData };
                    }
                    renderMenu();
                    renderManagementList();
                    maybeAutoSaveLocal();

                    if (isAutoCloudSyncEnabled()) {
                        await runCloudSync(() => setDoc(doc(menuCollectionRef, idToEdit), newItemData, { merge: true }));
                    }
                    customAlert(`${name} updated successfully!`, 'Success');
                } else {
                    // Add new item (local-first)
                    const newId = crypto.randomUUID();
                    menuItems.push({ id: newId, ...newItemData });
                    renderMenu();
                    renderManagementList();
                    maybeAutoSaveLocal();

                    if (isAutoCloudSyncEnabled()) {
                        await runCloudSync(() => setDoc(doc(menuCollectionRef, newId), newItemData, { merge: true }));
                    }
                    customAlert(`${name} added successfully!`, 'Success');
                }
                
                // Clear and reset the form
                document.getElementById('add-edit-item-form').reset();
                document.getElementById('item-id-to-edit').value = '';
                addSaveBtn.textContent = 'Add Item';
            } catch (error) {
                console.error("Error saving menu item:", error);
                customAlert("Failed to save item. Check console.", "Database Error", 'error');
            }
        }


        async function deleteMenuItem(itemId) {
            const itemToDelete = menuItems.find(item => item.id === itemId);
            if (!itemToDelete) return;

            const confirmed = await customConfirm(`Are you sure you want to delete "${itemToDelete.name}"? This action cannot be undone.`);

            if (confirmed) {
                try {
                    menuItems = menuItems.filter(item => item.id !== itemId);
                    renderMenu();
                    renderManagementList();
                    maybeAutoSaveLocal();

                    if (isAutoCloudSyncEnabled()) {
                        await runCloudSync(() => deleteDoc(doc(menuCollectionRef, itemId)));
                    }
                    customAlert(`${itemToDelete.name} deleted successfully!`, 'Success');
                } catch (error) {
                    console.error("Error deleting menu item:", error);
                    customAlert("Failed to delete item. Check console.", "Database Error", 'error');
                }
            }
        }


        function handleCSVUpload() {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];

            if (!file) {
                customAlert("Please select a CSV file to upload.", "File Required");
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async function(results) {
                    const data = results.data;
                    const batchItems = [];
                    let successCount = 0;
                    let errorCount = 0;
                    const existingNames = new Set(menuItems.map(item => item.name.toLowerCase()));

                    for (const row of data) {
                        const name = row.Name ? row.Name.trim() : null;
                        const price = parseFloat(row.Price);
                        const category = row.Category ? row.Category.trim() : null;
                        const normalizedName = name ? name.toLowerCase() : null;

                        if (name && !isNaN(price) && price > 0 && category) {
                            // Skip if name is already in the existing menu
                            if (existingNames.has(normalizedName)) {
                                console.warn(`Skipping duplicate item from CSV: ${name}`);
                                errorCount++;
                                continue;
                            }
                            // Add to batch and mark as handled to prevent duplicates within the CSV itself
                            batchItems.push({
                                id: crypto.randomUUID(),
                                name: name,
                                price: price,
                                category: category,
                            });
                            existingNames.add(normalizedName);
                            successCount++;
                        } else {
                            console.error("Skipping invalid CSV row:", row);
                            errorCount++;
                        }
                    }

                    if (batchItems.length > 0) {
                        try {
                            menuItems = [...menuItems, ...batchItems];
                            renderMenu();
                            renderManagementList();
                            maybeAutoSaveLocal();

                            if (isAutoCloudSyncEnabled()) {
                                const addPromises = batchItems.map(item => {
                                    const payload = { ...item };
                                    delete payload.id;
                                    return setDoc(doc(menuCollectionRef, item.id), payload, { merge: true });
                                });
                                await runCloudSync(() => Promise.all(addPromises));
                            }
                            customAlert(`Successfully imported ${successCount} items! ${errorCount} rows skipped (duplicates/errors).`, 'Import Complete');
                        } catch (error) {
                            console.error("Error importing items from CSV:", error);
                            customAlert("An error occurred during bulk import.", "Import Error", 'error');
                        }
                    } else {
                        customAlert("The CSV file contained no valid, non-duplicate menu items.", "Import Failed", 'error');
                    }
                    fileInput.value = ''; // Clear the file input
                }
            });
        }


        // --- SALES HISTORY LOGIC ---

        function showOrderHistoryModal() {
            if (!isMenuReady) {
                customAlert("Please wait until the app is fully initialized and data is loaded.", "Not Ready");
                return;
            }
            document.getElementById('order-history-modal').style.display = 'flex';
            renderOrderHistory();
        }

        function hideOrderHistoryModal() {
            document.getElementById('order-history-modal').style.display = 'none';
        }

        function getHistoryDateRange() {
            const fromInput = document.getElementById('history-from-date').value;
            const toInput = document.getElementById('history-to-date').value;
            const fromDate = fromInput ? new Date(`${fromInput}T00:00:00`) : null;
            const toDate = toInput ? new Date(`${toInput}T23:59:59.999`) : null;
            return { fromDate, toDate };
        }

        function filterOrdersByDate(orders) {
            const { fromDate, toDate } = getHistoryDateRange();
            if (!fromDate && !toDate) return orders;

            return orders.filter(order => {
                if (!order.timestamp) return false;
                const orderDate = order.timestamp.toDate ? order.timestamp.toDate() : new Date(order.timestamp);
                if (Number.isNaN(orderDate.getTime())) return false;
                if (fromDate && orderDate < fromDate) return false;
                if (toDate && orderDate > toDate) return false;
                return true;
            });
        }

        function renderSalesHistoryFromCache() {
            const historyContent = document.getElementById('order-history-content');
            historyContent.innerHTML = '';

            if (!salesHistoryCache || salesHistoryCache.length === 0) {
                historyContent.innerHTML = `<p class="text-gray-500 text-center italic mt-4 p-8">No completed orders found in history.</p>`;
                salesHistoryFiltered = [];
                toggleExportReadyState(false);
                return;
            }

            const filteredOrders = filterOrdersByDate(salesHistoryCache);
            salesHistoryFiltered = filteredOrders;
            toggleExportReadyState(filteredOrders.length > 0);

            if (filteredOrders.length === 0) {
                historyContent.innerHTML = `<p class="text-gray-500 text-center italic mt-4 p-8">No orders found for the selected date range.</p>`;
                return;
            }

            // Group orders by date
            const ordersByDate = filteredOrders.reduce((groups, order) => {
                const dateObj = order.timestamp?.toDate ? order.timestamp.toDate() : new Date(order.timestamp);
                if (Number.isNaN(dateObj.getTime())) return groups;
                const dateKey = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                if (!groups[dateKey]) {
                    groups[dateKey] = [];
                }
                groups[dateKey].push(order);
                return groups;
            }, {});

            let historyHTML = '';

            for (const dateKey of Object.keys(ordersByDate)) {
                const dailyTotal = ordersByDate[dateKey].reduce((sum, order) => sum + order.totalPayable, 0).toFixed(2);
                
                historyHTML += `
                    <div class="border border-indigo-200 rounded-xl shadow-lg">
                        <h4 class="text-lg font-bold text-white bg-indigo-500 p-3 rounded-t-xl flex justify-between">
                            <span>${dateKey}</span>
                            <span>Daily Total: â‚¹${dailyTotal}</span>
                        </h4>
                        <div class="p-4 space-y-3">
                            ${ordersByDate[dateKey].map(order => `
                                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 shadow-sm">
                                    <div class="flex justify-between font-semibold text-gray-800">
                                        <span>Order Time: ${(order.timestamp?.toDate ? order.timestamp.toDate() : new Date(order.timestamp)).toLocaleTimeString()}</span>
                                        <span>Total: â‚¹${order.totalPayable.toFixed(2)}</span>
                                    </div>
                                    <p class="text-xs text-gray-600">Type: ${order.orderType || 'N/A'}</p>
                                    <p class="text-xs text-gray-600 mb-2">Counter: ${order.counter || 'N/A'}</p>
                                    <ul class="text-sm list-disc list-inside text-gray-700 space-y-0.5">
                                        ${order.items.map(item => `
                                            <li>${item.name} x${item.quantity} (â‚¹${item.total.toFixed(2)})</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            historyContent.innerHTML = historyHTML;
        }

        function applySalesHistoryFilter() {
            renderSalesHistoryFromCache();
        }

        function clearSalesHistoryFilter() {
            document.getElementById('history-from-date').value = '';
            document.getElementById('history-to-date').value = '';
            renderSalesHistoryFromCache();
        }

        function exportSalesHistoryCSV() {
            if (!salesHistoryFiltered || salesHistoryFiltered.length === 0) {
                customAlert("There are no sales records to export.", "No Data");
                return;
            }

            const headers = [
                'Date',
                'Time',
                'Order Type',
                'Counter',
                'Subtotal',
                'GST %',
                'GST Amount',
                'Total',
                'Items'
            ];

            const rows = salesHistoryFiltered.map(order => {
                const { date, time } = formatTimestamp(order.timestamp);
                const taxPercent = Number.isFinite(order.taxPercent) ? order.taxPercent : restaurantSettings.gstPercent;
                const items = Array.isArray(order.items)
                    ? order.items.map(item => `${item.name} x${item.quantity} (â‚¹${Number(item.total || 0).toFixed(2)})`).join(' | ')
                    : '';

                return [
                    date,
                    time,
                    order.orderType || '',
                    order.counter || '',
                    Number(order.subtotal || 0).toFixed(2),
                    Number(taxPercent || 0).toFixed(2),
                    Number(order.taxAmount || 0).toFixed(2),
                    Number(order.totalPayable || 0).toFixed(2),
                    items
                ].map(csvEscape).join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const fileDate = new Date().toISOString().slice(0, 10);
            const fileBase = slugifyFilename(restaurantSettings.restaurantName);

            link.href = url;
            link.download = `${fileBase}-sales-${fileDate}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function renderOrderHistory() {
            const historyContent = document.getElementById('order-history-content');
            historyContent.innerHTML = `<p class="text-gray-400 text-center italic mt-4">Fetching sales data...</p>`;
            
            if (!isAutoCloudSyncEnabled() || !ordersCollectionRef) {
                renderSalesHistoryFromCache();
                return;
            }
            toggleExportReadyState(false);

            try {
                // NOTE: Using getDocs instead of onSnapshot for history to fetch once
                // Fetch all and sort in memory as orderBy is discouraged due to index requirements
                const querySnapshot = await getDocs(ordersCollectionRef);
                let orders = [];
                querySnapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });

                // Sort orders by timestamp DESC (newest first) in memory
                orders.sort((a, b) => {
                    // Safely handle potential null/undefined timestamps (though serverTimestamp should prevent this)
                    const aTime = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : 0;
                    const bTime = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : 0;
                    return aTime - bTime;
                });

                salesHistoryCache = orders;
                renderSalesHistoryFromCache();
                maybeAutoSaveLocal();

            } catch (error) {
                console.error("Error fetching order history:", error);
                historyContent.innerHTML = `<p class="text-red-500 text-center italic mt-4">Failed to load sales history due to an error.</p>`;
            }
        }


        // --- GEMINI AI INTEGRATION (DAILY SPECIAL) ---

        async function generateDailySpecial() {
            if (!isMenuReady) {
                customAlert("Please wait until the app is fully initialized.", "Not Ready");
                return;
            }

            const menuList = menuItems.map(item => `${item.name} (${item.category}) - â‚¹${item.price.toFixed(2)}`).join('\n');
            
            const systemPrompt = "You are a creative executive chef and menu consultant for a modern Indian restaurant. Your task is to invent one new, exciting vegetarian dish that complements the existing menu. The dish must be a limited-time 'Daily Special'. Provide a descriptive name, a compelling description, and a realistic price in INR. The price should be slightly premium (20% higher than the average dish). Do not use markdown formatting in the output, only the JSON structure.";
            
            const userQuery = `My current menu items are:\n---\n${menuList}\n---\nBased on this, suggest one creative and compelling vegetarian Daily Special.`;

            // Disable button and show loading state
            generateSpecialBtn.disabled = true;
            generateSpecialBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
            
            try {
                // Step 1: Remove any previous special from the menu if it exists
                const existingSpecial = menuItems.find(item => item.isSpecial);
                if (existingSpecial) {
                    menuItems = menuItems.filter(item => item.id !== existingSpecial.id);
                    renderMenu();
                    renderManagementList();
                    maybeAutoSaveLocal();
                    if (isAutoCloudSyncEnabled() && menuCollectionRef) {
                        await runCloudSync(() => deleteDoc(doc(menuCollectionRef, existingSpecial.id)));
                    }
                }

                // Step 2: Call the LOCAL PROXY ENDPOINT
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                suggestedName: { type: "STRING", description: "The descriptive name of the dish." },
                                suggestedPrice: { type: "NUMBER", description: "The price of the dish (e.g., 320.00)." },
                                suggestedDescription: { type: "STRING", description: "A short, compelling description." }
                            }
                        }
                    }
                };

                // CRITICAL CHANGE: Fetch from the local proxy, which handles the API key securely.
                const response = await fetch(PROXY_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`Proxy call failed. Status: ${response.status}. See server console for details.`);

                const result = await response.json();
                
                // Handle potential errors returned *from* the proxy/Gemini API inside the 200 response
                if (result.error) {
                    throw new Error(result.details || result.error);
                }

                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const specialData = JSON.parse(jsonText);

                // Step 3: Add the new special
                const newSpecial = {
                    name: specialData.suggestedName,
                    price: parseFloat(specialData.suggestedPrice),
                    category: 'Daily Special',
                    description: specialData.suggestedDescription,
                    isSpecial: true, // Marker for styling and tracking
                };
                const newId = crypto.randomUUID();
                menuItems.push({ id: newId, ...newSpecial });
                renderMenu();
                renderManagementList();
                maybeAutoSaveLocal();

                if (isAutoCloudSyncEnabled() && menuCollectionRef) {
                    await runCloudSync(() => setDoc(doc(menuCollectionRef, newId), newSpecial, { merge: true }));
                }
                customAlert(`AI Special added: ${newSpecial.name}!`, 'New Special');

            } catch (error) {
                console.error("AI Generation Error:", error);
                customAlert(`Failed to generate special. Error: ${error.message}. Check your Node.js console.`, "AI Error", 'error');
            } finally {
                // Re-enable button and reset text
                generateSpecialBtn.disabled = !isMenuReady;
                generateSpecialBtn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4 mr-1"></i> Generate Daily Special';
                lucide.createIcons();
            }
        }


        // --- APPLICATION STARTUP ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase services and set up authentication
            initializeFirebase();
            
            // Set up search listener
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('keyup', renderMenu);
            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const value = searchInput.value.trim();
                    if (value) {
                        renderMenu();
                        addBestMatchFromSearch();
                        enterTapCount = 0;
                        lastEnterTapAt = 0;
                        return;
                    }
                    handleDoubleEnterFocus();
                }
            });

            bindSelectFlow('order-type', () => focusCounterControl(), () => toggleTableSelection());
            bindSelectFlow('counter-select', () => {
                const orderType = document.getElementById('order-type').value;
                if (orderType === 'Table/Dine-In') {
                    focusTableControl();
                } else {
                    focusPrintButton();
                }
            }, (value) => {
                if (value) selectCounter(value, { silent: true, focusSearch: false });
            });
            bindSelectFlow('table-select', () => focusPrintButton(), (value) => {
                if (value) selectTable(value, { silent: true, focusSearch: false });
            });

            document.getElementById('counter-custom-input').addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    applyCustomCounter();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key !== 'Enter') return;
                const active = document.activeElement;
                if (active && (active.id === 'search-input' || active.tagName === 'INPUT' || active.tagName === 'SELECT' || active.tagName === 'TEXTAREA' || active.tagName === 'BUTTON')) {
                    return;
                }
                handleDoubleEnterFocus();
            });

            if (autoCloudSyncToggle) {
                autoCloudSyncToggle.addEventListener('change', () => {
                    setAutoCloudSyncEnabled(autoCloudSyncToggle.checked);
                    if (autoCloudSyncToggle.checked) {
                        syncToCloud(true).finally(() => startCloudSync());
                    } else {
                        stopCloudSync();
                    }
                });
            }

            const counterGrid = document.getElementById('counter-grid');
            if (counterGrid) {
                counterGrid.addEventListener('keydown', (event) => {
                    handleGridKeyNavigation(event, '.counter-btn', 3, (btn) => {
                        const value = btn.getAttribute('data-counter');
                        if (!value) return;
                        selectCounter(value, { focusSearch: false });
                    });
                });
            }

            const tableGrid = document.getElementById('table-grid');
            if (tableGrid) {
                tableGrid.addEventListener('keydown', (event) => {
                    handleGridKeyNavigation(event, '.table-btn', 3, (btn) => {
                        const value = btn.getAttribute('data-table');
                        if (!value) return;
                        selectTable(value, { focusSearch: false });
                    });
                });
            }

            // Initialize table selection visibility
            toggleTableSelection();

            // Re-render the current order state (will be empty on load)
            renderOrder();

            // Apply default settings before Firebase data arrives
            applySettings(restaurantSettings);
            
            // Render initial Lucide icons
            lucide.createIcons();
        });


        // Expose functions globally for HTML element handlers (onclick)
        window.addItemToOrderById = addItemToOrderById;
        window.addItemToOrder = addItemToOrder;
        window.updateQuantity = updateQuantity;
        window.printBill = printBill;
        window.clearOrder = clearOrder;
        window.renderMenu = renderMenu;
        window.generateDailySpecial = generateDailySpecial;
        window.showManageMenuModal = showManageMenuModal;
        window.hideManageMenuModal = hideManageMenuModal;
        window.showSettingsModal = showSettingsModal;
        window.hideSettingsModal = hideSettingsModal;
        window.saveSettings = saveSettings;
        window.handleCSVUpload = handleCSVUpload;
        window.saveMenuItem = saveMenuItem;
        window.editMenuItem = editMenuItem;
        window.deleteMenuItem = deleteMenuItem;
        window.showOrderHistoryModal = showOrderHistoryModal;
        window.hideOrderHistoryModal = hideOrderHistoryModal;
        window.exportSalesHistoryCSV = exportSalesHistoryCSV;
        window.applySalesHistoryFilter = applySalesHistoryFilter;
        window.clearSalesHistoryFilter = clearSalesHistoryFilter;
        window.syncToCloud = syncToCloud;
        window.syncFromCloud = syncFromCloud;
        window.handleAuth = handleAuth;
        window.signOutUser = signOutUser;
        window.selectTable = selectTable;
        window.toggleTableSelection = toggleTableSelection;
        window.selectCounter = selectCounter;
        window.applyCustomCounter = applyCustomCounter;
        window.expandStep = expandStep;
        window.handleCompactCounterChange = handleCompactCounterChange;
        window.handleCompactTableChange = handleCompactTableChange;
    </script>
</body>
</html>
